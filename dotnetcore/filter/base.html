<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <title>过滤器基本使用 | 知识库</title><meta name="description" content="一个知识库网站">
    <link rel="modulepreload" href="/assets/app.f6b99883.js"><link rel="modulepreload" href="/assets/base.html.8c7b6aa2.js"><link rel="modulepreload" href="/assets/base.html.68c649b6.js"><link rel="prefetch" href="/assets/index.html.e0baf728.js"><link rel="prefetch" href="/assets/attribute.html.c664a011.js"><link rel="prefetch" href="/assets/class.html.aba60eb7.js"><link rel="prefetch" href="/assets/predefined-type.html.688911ae.js"><link rel="prefetch" href="/assets/reflect.html.078024e0.js"><link rel="prefetch" href="/assets/type-convert.html.36fe72f4.js"><link rel="prefetch" href="/assets/base.html.f9c655ac.js"><link rel="prefetch" href="/assets/healthcheck.html.9e2087e3.js"><link rel="prefetch" href="/assets/kuayu.html.8281e724.js"><link rel="prefetch" href="/assets/reflect.html.42d66291.js"><link rel="prefetch" href="/assets/routing.html.7d232251.js"><link rel="prefetch" href="/assets/http-agency.html.700b7525.js"><link rel="prefetch" href="/assets/introduce.html.a7e10533.js"><link rel="prefetch" href="/assets/cookie.html.2d2ba37e.js"><link rel="prefetch" href="/assets/jwt_baseuse.html.a34abee3.js"><link rel="prefetch" href="/assets/session.html.51ca4e17.js"><link rel="prefetch" href="/assets/memorycache.html.e339a66b.js"><link rel="prefetch" href="/assets/redis.html.f76ecd58.js"><link rel="prefetch" href="/assets/configread.html.484c0113.js"><link rel="prefetch" href="/assets/realize.html.aa8b6b54.js"><link rel="prefetch" href="/assets/default.html.061226e7.js"><link rel="prefetch" href="/assets/base.html.0d78b979.js"><link rel="prefetch" href="/assets/base.html.ed04ab9f.js"><link rel="prefetch" href="/assets/ilogger.html.68a40a4d.js"><link rel="prefetch" href="/assets/log4net.html.d04538bf.js"><link rel="prefetch" href="/assets/logdashboard.html.9d2d9b2f.js"><link rel="prefetch" href="/assets/nlog.html.e870fcdd.js"><link rel="prefetch" href="/assets/serilog.html.7fe8bd19.js"><link rel="prefetch" href="/assets/base.html.c4527071.js"><link rel="prefetch" href="/assets/createdb.html.b44a1837.js"><link rel="prefetch" href="/assets/efcoreoperation.html.64ab049a.js"><link rel="prefetch" href="/assets/base.html.1f552307.js"><link rel="prefetch" href="/assets/centos_net6.html.f4c3d097.js"><link rel="prefetch" href="/assets/docker.html.2b91f4af.js"><link rel="prefetch" href="/assets/iis.html.8b925361.js"><link rel="prefetch" href="/assets/supervisor.html.69a9b968.js"><link rel="prefetch" href="/assets/swagger-long.html.50e69bc0.js"><link rel="prefetch" href="/assets/swaggerbase.html.f971e002.js"><link rel="prefetch" href="/assets/version.html.71967fb8.js"><link rel="prefetch" href="/assets/base-use-dissent.html.445c2fce.js"><link rel="prefetch" href="/assets/base-use.html.91aaf579.js"><link rel="prefetch" href="/assets/base.html.1b7b52cb.js"><link rel="prefetch" href="/assets/base.html.0b4da2a9.js"><link rel="prefetch" href="/assets/customerconfig.html.a845d8e6.js"><link rel="prefetch" href="/assets/webapi-base.html.e2eef8b0.js"><link rel="prefetch" href="/assets/webapiversion.html.f588f73f.js"><link rel="prefetch" href="/assets/use_di.html.ebeef32d.js"><link rel="prefetch" href="/assets/404.html.98e87f94.js"><link rel="prefetch" href="/assets/index.html.72ac4063.js"><link rel="prefetch" href="/assets/index.html.31368430.js"><link rel="prefetch" href="/assets/attribute.html.e467a053.js"><link rel="prefetch" href="/assets/class.html.f265b57e.js"><link rel="prefetch" href="/assets/predefined-type.html.b462bd96.js"><link rel="prefetch" href="/assets/reflect.html.ea6a3059.js"><link rel="prefetch" href="/assets/type-convert.html.cca277f4.js"><link rel="prefetch" href="/assets/base.html.9ecc9ddf.js"><link rel="prefetch" href="/assets/healthcheck.html.9ba974c0.js"><link rel="prefetch" href="/assets/kuayu.html.054b893e.js"><link rel="prefetch" href="/assets/reflect.html.1b167085.js"><link rel="prefetch" href="/assets/routing.html.f6e2ade1.js"><link rel="prefetch" href="/assets/http-agency.html.433ecf89.js"><link rel="prefetch" href="/assets/introduce.html.368c37f8.js"><link rel="prefetch" href="/assets/cookie.html.581f716b.js"><link rel="prefetch" href="/assets/jwt_baseuse.html.611f0be6.js"><link rel="prefetch" href="/assets/session.html.66f95c24.js"><link rel="prefetch" href="/assets/memorycache.html.1e263ef2.js"><link rel="prefetch" href="/assets/redis.html.c6d32df5.js"><link rel="prefetch" href="/assets/configread.html.de625ecd.js"><link rel="prefetch" href="/assets/realize.html.105a015d.js"><link rel="prefetch" href="/assets/default.html.6aa8210d.js"><link rel="prefetch" href="/assets/base.html.c314bee1.js"><link rel="prefetch" href="/assets/base.html.06713cfe.js"><link rel="prefetch" href="/assets/ilogger.html.9fb7fb05.js"><link rel="prefetch" href="/assets/log4net.html.48059ec2.js"><link rel="prefetch" href="/assets/logdashboard.html.17c3d546.js"><link rel="prefetch" href="/assets/nlog.html.f4ffcfa4.js"><link rel="prefetch" href="/assets/serilog.html.d2badab6.js"><link rel="prefetch" href="/assets/base.html.4ac8da5f.js"><link rel="prefetch" href="/assets/createdb.html.f40ec7fa.js"><link rel="prefetch" href="/assets/efcoreoperation.html.96ff7d6b.js"><link rel="prefetch" href="/assets/base.html.4a032973.js"><link rel="prefetch" href="/assets/centos_net6.html.8b5338d4.js"><link rel="prefetch" href="/assets/docker.html.9cc216c5.js"><link rel="prefetch" href="/assets/iis.html.c24cdea8.js"><link rel="prefetch" href="/assets/supervisor.html.598f5c25.js"><link rel="prefetch" href="/assets/swagger-long.html.90cf5c8c.js"><link rel="prefetch" href="/assets/swaggerbase.html.9c8f1a99.js"><link rel="prefetch" href="/assets/version.html.f54578ec.js"><link rel="prefetch" href="/assets/base-use-dissent.html.fdd74390.js"><link rel="prefetch" href="/assets/base-use.html.b0bfa199.js"><link rel="prefetch" href="/assets/base.html.358cc5cd.js"><link rel="prefetch" href="/assets/base.html.bc5662ee.js"><link rel="prefetch" href="/assets/customerconfig.html.a11618f0.js"><link rel="prefetch" href="/assets/webapi-base.html.2cd20c0f.js"><link rel="prefetch" href="/assets/webapiversion.html.955249f6.js"><link rel="prefetch" href="/assets/use_di.html.c100dcf3.js"><link rel="prefetch" href="/assets/404.html.3b64f271.js"><link rel="prefetch" href="/assets/index.html.fbe52f75.js"><link rel="prefetch" href="/assets/reco-valine.ed4545b0.js">
    <link rel="stylesheet" href="/assets/style.180fd05c.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><div class="common-wrapper"><div><header class="navbar-container"><span class="nav-item site-brand"><a href="/" class=""><img class="logo" src="/logo.png" alt="知识库"><span class="site-name can-hide">知识库</span></a></span><div class="nav-item navbar-links-wrapper" style=""><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="主页"><!--[--><!--]--> 主页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="目录">目录 <span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="目录"><span class="title"><span>目录</span></span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/web/introduce" class="nav-link" aria-label="Web"><!--[--><!--]--> Web <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/csharp/predefined-type" class="nav-link" aria-label="CSharp"><!--[--><!--]--> CSharp <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/dotnetcore/base" class="nav-link" aria-label="dotnetcore"><!--[--><!--]--> dotnetcore <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><a class="icon-container left btn-toggle-dark-mode" href="javascript:void(0)" target="_self"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" style="color:inherit;width:19px;height:19px;font-size:19px;"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"></path><path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0-2 2a2 2 0 0 0-2-2a2 2 0 0 0 2-2"></path><path d="M19 11h2m-1-1v2"></path></g></svg><!----></a><a class="icon-container left btn-toggle-menus" href="javascript:void(0)" target="_self"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" style="color:inherit;width:20px;height:20px;font-size:20px;"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle><circle cx="12" cy="5" r="1"></circle></g></svg><!----></a></div></header><div class="mobile-menus-container"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="主页"><!--[--><!--]--> 主页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="目录">目录 <span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="目录"><span class="title"><span>目录</span></span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/web/introduce" class="nav-link" aria-label="Web"><!--[--><!--]--> Web <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/csharp/predefined-type" class="nav-link" aria-label="CSharp"><!--[--><!--]--> CSharp <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/dotnetcore/base" class="nav-link" aria-label="dotnetcore"><!--[--><!--]--> dotnetcore <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><div class="appearance"><span>Appearance </span><a class="icon-container left btn-toggle-dark-mode" href="javascript:void(0)" target="_self"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" style="color:inherit;width:19px;height:19px;font-size:19px;"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"></path><path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0-2 2a2 2 0 0 0-2-2a2 2 0 0 0 2-2"></path><path d="M19 11h2m-1-1v2"></path></g></svg><!----></a></div></div><div class="sidebar-mask"></div><aside class="series-container"><!--[--><!--[--><section class="series-group series-item"><h5 class="series-heading">基础知识</h5><ul><li><!--[--><a href="/dotnetcore/base.html" class="nav-link series-item" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/globalization/base.html" class="nav-link series-item" aria-label="多语言配置"><!--[--><!--]--> 多语言配置 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/routing.html" class="nav-link series-item" aria-label="路由"><!--[--><!--]--> 路由 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/healthcheck.html" class="nav-link series-item" aria-label="健康检查"><!--[--><!--]--> 健康检查 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">配置框架</h5><ul><li><!--[--><a href="/dotnetcore/config/configread.html" class="nav-link series-item" aria-label="配置读取"><!--[--><!--]--> 配置读取 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">跨域</h5><ul><li><!--[--><a href="/dotnetcore/kuayu.html" class="nav-link series-item" aria-label="跨域"><!--[--><!--]--> 跨域 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">静态资源</h5><ul><li><!--[--><a href="/dotnetcore/staticfile/base.html" class="nav-link series-item" aria-label="静态资源-基本设置"><!--[--><!--]--> 静态资源-基本设置 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/staticfile/customerconfig.html" class="nav-link series-item" aria-label="静态资源-自定义设置"><!--[--><!--]--> 静态资源-自定义设置 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">日志</h5><ul><li><!--[--><a href="/dotnetcore/loggers/ilogger.html" class="nav-link series-item" aria-label="Logger"><!--[--><!--]--> Logger <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/loggers/serilog.html" class="nav-link series-item" aria-label="Serilog"><!--[--><!--]--> Serilog <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/loggers/nlog.html" class="nav-link series-item" aria-label="NLog"><!--[--><!--]--> NLog <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/loggers/log4net.html" class="nav-link series-item" aria-label="Log4net"><!--[--><!--]--> Log4net <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/loggers/logdashboard.html" class="nav-link series-item" aria-label="LogDashboard"><!--[--><!--]--> LogDashboard <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading active">过滤器</h5><ul><li><!--[--><a aria-current="page" href="/dotnetcore/filter/base.html" class="router-link-active router-link-exact-active nav-link router-link-active series-item active" aria-label="过滤器基本使用"><!--[--><!--]--> 过滤器基本使用 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/filter/realize.html" class="nav-link series-item" aria-label="过滤器常见操作"><!--[--><!--]--> 过滤器常见操作 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">OpenApi</h5><ul><li><!--[--><a href="/dotnetcore/openapi/swaggerbase.html" class="nav-link series-item" aria-label="swagger-基础使用"><!--[--><!--]--> swagger-基础使用 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/openapi/version.html" class="nav-link series-item" aria-label="swagger-版本控制"><!--[--><!--]--> swagger-版本控制 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">身份认证和授权</h5><ul><li><!--[--><a href="/dotnetcore/auth/session.html" class="nav-link series-item" aria-label="Session"><!--[--><!--]--> Session <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/auth/cookie.html" class="nav-link series-item" aria-label="Cookie"><!--[--><!--]--> Cookie <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/auth/jwt_baseuse.html" class="nav-link series-item" aria-label="Jwt使用"><!--[--><!--]--> Jwt使用 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">健康检查</h5><ul><li><!--[--><a href="/dotnetcore/healthcheck.html" class="nav-link series-item" aria-label="健康检查"><!--[--><!--]--> 健康检查 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">实时通信</h5><ul><li><!--[--><a href="/dotnetcore/real-time/base.html" class="nav-link series-item" aria-label="实时通信-技术大乱斗"><!--[--><!--]--> 实时通信-技术大乱斗 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">缓存</h5><ul><li><!--[--><a href="/dotnetcore/cache/memorycache.html" class="nav-link series-item" aria-label="MemoryCache"><!--[--><!--]--> MemoryCache <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/cache/redis.html" class="nav-link series-item" aria-label="分布式缓存"><!--[--><!--]--> 分布式缓存 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">身份认证和授权</h5><ul><li><!--[--><a href="/dotnetcore/auth/session.html" class="nav-link series-item" aria-label="Session"><!--[--><!--]--> Session <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">IOC</h5><ul><li><!--[--><a href="/dotnetcore/ioc/base.html" class="nav-link series-item" aria-label="控制反转"><!--[--><!--]--> 控制反转 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/DI/default.html" class="nav-link series-item" aria-label="默认依赖注入"><!--[--><!--]--> 默认依赖注入 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">WebAPI</h5><ul><li><!--[--><a href="/dotnetcore/webapi/webapi-base.html" class="nav-link series-item" aria-label="WebApi调用示例"><!--[--><!--]--> WebApi调用示例 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/webapi/webapiversion.html" class="nav-link series-item" aria-label="API版本控制"><!--[--><!--]--> API版本控制 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">操作数据库</h5><ul><li><!--[--><a href="/dotnetcore/orm/createdb.html" class="nav-link series-item" aria-label="EFCore-生成数据库"><!--[--><!--]--> EFCore-生成数据库 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/orm/efcoreoperation.html" class="nav-link series-item" aria-label="EFCore-增删改查"><!--[--><!--]--> EFCore-增删改查 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">单元测试</h5><ul><li><!--[--><a href="/dotnetcore/unit-test/base.html" class="nav-link series-item" aria-label="基础介绍"><!--[--><!--]--> 基础介绍 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/unit-test/base-use-dissent.html" class="nav-link series-item" aria-label="简单使用-争议篇"><!--[--><!--]--> 简单使用-争议篇 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/unit-test/base-use.html" class="nav-link series-item" aria-label="单元测试简单使用"><!--[--><!--]--> 单元测试简单使用 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">WinForm</h5><ul><li><!--[--><a href="/dotnetcore/winform/use_di.html" class="nav-link series-item" aria-label="WinForm使用依赖注入"><!--[--><!--]--> WinForm使用依赖注入 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">部署</h5><ul><li><!--[--><a href="/dotnetcore/release/iis.html" class="nav-link series-item" aria-label="IIS部署DotNet5"><!--[--><!--]--> IIS部署DotNet5 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/release/centos_net6.html" class="nav-link series-item" aria-label="Centos7部署和守护进程"><!--[--><!--]--> Centos7部署和守护进程 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/release/supervisor.html" class="nav-link series-item" aria-label="部署之Supervisor基础"><!--[--><!--]--> 部署之Supervisor基础 <!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/dotnetcore/release/docker.html" class="nav-link series-item" aria-label="Docker部署详细流程"><!--[--><!--]--> Docker部署详细流程 <!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--]--></aside><!--[--><main class="page-container show-series show-catalog"><h1 class="page-title">过滤器基本使用</h1><div class="page-info"><a class="icon-container left" href="javascript:void(0)" target="_self"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" style="color:inherit;width:18px;height:18px;font-size:18px;"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="7" r="4"></circle><path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"></path></g></svg><span style="color:inherit;font-size:14px;" class="icon-text"><!--[-->azrng<!--]--></span></a><a class="icon-container left" href="javascript:void(0)" target="_self"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" style="color:inherit;width:18px;height:18px;font-size:18px;"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 7v5l3 3"></path></g></svg><span style="color:inherit;font-size:14px;" class="icon-text"><!--[-->2022-08-25<!--]--></span></a><a class="icon-container left" href="javascript:void(0)" target="_self"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" style="color:inherit;width:18px;height:18px;font-size:18px;"><path d="M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><span style="color:inherit;font-size:14px;" class="icon-text"><!--[-->dotNet<!--]--></span></a><a class="icon-container left" href="javascript:void(0)" target="_self"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" style="color:inherit;width:18px;height:18px;font-size:18px;"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8.5" cy="8.5" r="1" fill="currentColor"></circle><path d="M4 7v3.859c0 .537.213 1.052.593 1.432l8.116 8.116a2.025 2.025 0 0 0 2.864 0l4.834-4.834a2.025 2.025 0 0 0 0-2.864L12.29 4.593A2.025 2.025 0 0 0 10.859 4H7a3 3 0 0 0-3 3z"></path></g></svg><span style="color:inherit;font-size:14px;" class="icon-text"><!--[-->filter<!--]--></span></a><!----></div><div class="theme-reco-default-content"><div><h1 id="过滤器基本使用" tabindex="-1"><a class="header-anchor" href="#过滤器基本使用" aria-hidden="true">#</a> 过滤器基本使用</h1><h1 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h1><p>过滤器就是对目标对象(程序集、类、方法等)进行扩展，使得在运行时可以获取到被扩展对象的额外的信息，通过额外的信息来影响目标对象的行为。</p><p>ASP.NET Core 有以下五种Filter 可以使用：</p><p><img src="https://gitee.com/AZRNG/picture-storage/raw/master/kbms/202202272047210.png" alt="img"></p><p><strong>中间件和过滤器的功能类似，区别就是关注点是不同的，所要处理的职责不同，过滤器是更贴合业务的，关注应用程序本身</strong>（可以对你请求的数据或者返回的结果进行处理操作，中间件是没有这个能力的），中间件都可以在请求之前和之后进行操作。请求完成之后传递给下一个请求。</p><p>netcore和net相比增加了资源过滤器和结果过滤器，并且异常过滤器和方法过滤器设置了异步的使用方法，如果同步过滤器和异步的都设置了，那么只会调用异步的方法。</p><p>示例代码环境：vs2022、.Net6</p><p>源码地址：https://github.com/azrng/dotnet-sample/tree/main/src/MVCFilter</p><h1 id="过滤器特性" tabindex="-1"><a class="header-anchor" href="#过滤器特性" aria-hidden="true">#</a> 过滤器特性</h1><h2 id="作用范围" tabindex="-1"><a class="header-anchor" href="#作用范围" aria-hidden="true">#</a> 作用范围</h2><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>Class <span class="token operator">|</span> AttributeTargets<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> AllowMultiple <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> Inherited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiResultFilterAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IAsyncResultFilter</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>第一行指定了该特性作用的范围，AttributeTargets就是目标对象，是一个枚举</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//指定可以对它们应用属性的应用程序元素。</span>
<span class="token punctuation">[</span><span class="token function">ComVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Flags</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">AttributeTargets</span>
<span class="token punctuation">{</span>
    <span class="token comment">//可以对程序集应用属性。</span>
    Assembly <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对模块应用属性。</span>
    Module <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对类应用属性。</span>
    Class <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对结构应用属性，即值类型。</span>
    Struct <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
    Enum <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对构造函数应用属性。</span>
    Constructor <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对方法应用属性。</span>
    Method <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对属性 (Property) 应用属性 (Attribute)。</span>
    Property <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对字段应用属性。</span>
    Field <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对事件应用属性。</span>
    Event <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对接口应用属性。</span>
    Interface <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对参数应用属性。</span>
    Parameter <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对委托应用属性。</span>
    Delegate <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对返回值应用属性。</span>
    ReturnValue <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对泛型参数应用属性。</span>
    GenericParameter <span class="token operator">=</span> <span class="token number">16384</span><span class="token punctuation">,</span>
    <span class="token comment">//可以对任何应用程序元素应用属性。</span>
    All <span class="token operator">=</span> <span class="token number">32767</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="过滤器类型" tabindex="-1"><a class="header-anchor" href="#过滤器类型" aria-hidden="true">#</a> 过滤器类型</h1><p>下面过滤器的顺序就是执行的顺序</p><p><img src="https://gitee.com/AZRNG/picture-storage/raw/master/kbms/202202272047653.png" alt="img"></p><p>以下示例引用nuget包</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token operator">&lt;</span><span class="token class-name">PackageReference</span> Include<span class="token operator">=</span><span class="token string">&quot;AzrngCommon&quot;</span> Version<span class="token operator">=</span><span class="token string">&quot;1.2.5&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果过滤器中使用了构造函数注入，那么我们需要使用到ServiceFilter</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//[Authorization_01Filter]//无参数过滤器</span>
<span class="token punctuation">[</span><span class="token function">ServiceFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Authorization_01Filter</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> <span class="token function">Get01</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>并且这个过滤器也需要进行注册，例如注册这个授权过滤器</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//授权过滤器</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddScoped</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Authorization_01Filter</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="authorization-filter" tabindex="-1"><a class="header-anchor" href="#authorization-filter" aria-hidden="true">#</a> Authorization Filter</h2><p>Authorization是五种Filter中优先级最高的，通常用于验证Request合不合法、用户身份是否被认证(然后授权等)、。</p><p>权限控制器过滤器，可以通过Authonization可以实现复杂的权限角色认证、登录授权等操作实现事例如下：</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>Class<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Authorization_01Filter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IAuthorizationFilter</span></span>
<span class="token punctuation">{</span>
    <span class="token comment">/*
     权限控制器过滤器，可以通过Authonization可以实现复杂的权限角色认证、登录授权等操作实现事例

     猜想：是否到底这一步的都应该是已经经过身份认证的用户，这边只是做一些授权操作，还是说这个地方做认证以及授权操作
     */</span>

    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Authorization_01Filter<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Authorization_01Filter</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Authorization_01Filter<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnAuthorization</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationFilterContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;进入授权过滤器&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         实现效果：自定义身份验证，当用户调用登录接口的时候，会查询数据库并且将该用户信息存入redis(格式Wie：key：随机数，value：用户信息)，然后返回随机数
         当请求其它接口的时候，验证请求头中是否传输了Authorization，如果没传直接返回401
         当传输了token，那么就拿着值去查询redis，然后验证通过后将用户信息存入上下文的User中

         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Key <span class="token operator">==</span> <span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResultModel</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;401&quot;</span><span class="token punctuation">,</span> Message <span class="token operator">=</span> <span class="token string">&quot;认证失败&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Key <span class="token operator">==</span> <span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token comment">//这里替换查询redis操作</span>
        <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResultModel</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;401&quot;</span><span class="token punctuation">,</span> Message <span class="token operator">=</span> <span class="token string">&quot;认证失败&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//如果查询到上面传输的信息，那么就存储到上下文中</span>
        <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>NameIdentifier<span class="token punctuation">,</span> <span class="token string">&quot;zyp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> claimIdentities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>ClaimsIdentity<span class="token punctuation">&gt;</span></span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsIdentity</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">AddIdentities</span><span class="token punctuation">(</span>claimIdentities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>异步方案</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>Class<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Authorization_01AsyncFilter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IAsyncAuthorizationFilter</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Authorization_01Filter<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Authorization_01AsyncFilter</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Authorization_01Filter<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">OnAuthorizationAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationFilterContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;进入授权过滤器&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Key <span class="token operator">==</span> <span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResultModel</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;401&quot;</span><span class="token punctuation">,</span> Message <span class="token operator">=</span> <span class="token string">&quot;认证失败&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Key <span class="token operator">==</span> <span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token comment">//这里替换查询redis操作</span>
        <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResultModel</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;401&quot;</span><span class="token punctuation">,</span> Message <span class="token operator">=</span> <span class="token string">&quot;认证失败&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//如果查询到上面传输的信息，那么就存储到上下文中</span>
        <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>NameIdentifier<span class="token punctuation">,</span> <span class="token string">&quot;zyp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> claimIdentities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>ClaimsIdentity<span class="token punctuation">&gt;</span></span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsIdentity</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">AddIdentities</span><span class="token punctuation">(</span>claimIdentities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用示例</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// 获取天气（同步验证IAuthorizationFilter）</span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>returns</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>returns</span><span class="token punctuation">&gt;</span></span></span>
<span class="token comment">//[Authorization_01Filter]//无参数过滤器</span>
<span class="token punctuation">[</span><span class="token function">ServiceFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Authorization_01Filter</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> <span class="token function">Get01</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> str <span class="token operator">=</span> <span class="token string">@&quot;
    业务逻辑开始处理
    处...
    理...
    中...
    业务逻辑结束处理&quot;</span><span class="token punctuation">;</span>
    _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">WeatherForecast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="resource-filter" tabindex="-1"><a class="header-anchor" href="#resource-filter" aria-hidden="true">#</a> Resource Filter</h2><p>Resource是第二优先，会在Authorization之后，Model Binding之前执行。通常会是需要对Model加工处理才用也适合做<strong>缓存</strong>,因为是在创建控制器实例之前执行的。</p><p>同步方案</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>All<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Resource_01Filter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IResourceFilter</span></span>
<span class="token punctuation">{</span>
    <span class="token comment">/*
     使用场景：可以做缓存：比如说第一次请求先到OnResourceExecuting，根据请求地址或者参数去判断是否已经保存数据，没有发现往下走创建Action实例，
    然后在OnResourceExecuted进行存储，然后再一次访问这个接口时候，OnResourceExecuting直接就赋值Result，所以就不再创建控制器实例

    具体示例：根据请求地址做接口缓存、根据请求参数做缓存处理
        */</span>

    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token doc-comment comment">/// 模拟数据源</span>
    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> _dictionaryCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Result_01Filter<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Resource_01Filter</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Result_01Filter<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token doc-comment comment">/// 在接口被调用前触发</span>
    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>context<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResourceExecuting</span><span class="token punctuation">(</span><span class="token class-name">ResourceExecutingContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;同步 OnResourceExecuting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method <span class="token operator">==</span> <span class="token string">&quot;Get&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//定义一个key存储缓存</span>
            <span class="token class-name"><span class="token keyword">string</span></span> key <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_dictionaryCache<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Key <span class="token operator">==</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">//如果缓存有内容就直接返回</span>
                context<span class="token punctuation">.</span>Result <span class="token operator">=</span> _dictionaryCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token class-name">IActionResult</span><span class="token punctuation">;</span>    <span class="token comment">//Result 短路器</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果没有缓存就接着运行，然后再executed里面设置缓存</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">EnableBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可以实现多次读取Body</span>
            <span class="token class-name"><span class="token keyword">var</span></span> sr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamReader</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> data <span class="token operator">=</span> sr<span class="token punctuation">.</span><span class="token function">ReadToEndAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAwaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//不允许同步读取</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token comment">//body取不到数据直接跳过，一般情况下不会出现该情况</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token comment">//获取到body的请求字符串</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;data=&quot;</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//根据请求字符串去做处理解析是否做缓存，本次示例是获取到请求的boyd里面的ID，如果存在id，那么就做资源缓存(id作为key)，</span>
            <span class="token class-name"><span class="token keyword">var</span></span> jobject <span class="token operator">=</span> JObject<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jobject<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">?.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">string</span></span> key <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> jobject<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_dictionaryCache<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Key <span class="token operator">==</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">//如果缓存有内容就直接返回</span>
                    context<span class="token punctuation">.</span>Result <span class="token operator">=</span> _dictionaryCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token class-name">IActionResult</span><span class="token punctuation">;</span>    <span class="token comment">//Result 短路器</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Seek</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SeekOrigin<span class="token punctuation">.</span>Begin<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取到Body后，重新设置Stream到起始位置</span>
            context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token doc-comment comment">/// 在接口调用结束时候触发</span>
    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>context<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResourceExecuted</span><span class="token punctuation">(</span><span class="token class-name">ResourceExecutedContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;异步 OnResourceExecuted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//把数据存储缓存 Key---path;  实际情况这里缓存应该加上过期时间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method <span class="token operator">==</span> <span class="token string">&quot;Get&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">string</span></span> key <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将请求路径作为缓存的key</span>
            _dictionaryCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>Result<span class="token punctuation">;</span><span class="token comment">//刚才接口返回的值</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Seek</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SeekOrigin<span class="token punctuation">.</span>Begin<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取到Body后，重新设置Stream到起始位置</span>
            context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> sr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamReader</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> data <span class="token operator">=</span> sr<span class="token punctuation">.</span><span class="token function">ReadToEndAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAwaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//不允许同步读取</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> jobject <span class="token operator">=</span> JObject<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jobject<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">?.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">string</span></span> key <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> jobject<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _dictionaryCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>Result<span class="token punctuation">;</span><span class="token comment">//刚才接口返回的值</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>异步方案</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>All<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Resource_02Filter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IAsyncResourceFilter</span></span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="action-filter" tabindex="-1"><a class="header-anchor" href="#action-filter" aria-hidden="true">#</a> Action Filter</h2><p>最常使用的Filter，请求和返回都会经过它。跟Resource Filter很类似，但并不会经过Model Binding,因为进这个过滤器的时候已经走过了Model Binding。</p><p>可以通过ActionFilter拦截每个执行方法进行一系列的操作，比如：执行日志、性能监控、数据校验参数验证或加密、权限控制等一系列操作。使用Action Filter 需要实现IActionFilter 抽象接口，IActionFilter 接口要求实现OnActionExecuted 和OnActionExecuting 方法</p><p>同步方案：</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>All<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Action_01Filter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IActionFilter</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Action_01Filter<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Action_01Filter</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Action_01Filter<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnActionExecuting</span><span class="token punctuation">(</span><span class="token class-name">ActionExecutingContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;action 执行前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//如果标记有允许所有，不做处理那么就跳过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>ActionDescriptor<span class="token punctuation">.</span>EndpointMetadata<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">AllowAnonymousAttribute</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//记录请求来的一些参数</span>
        <span class="token class-name"><span class="token keyword">var</span></span> queryUrl <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Query<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">string</span></span> path <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">string</span></span> name <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identity<span class="token punctuation">?.</span>Name<span class="token punctuation">;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Action信息  queryUrl:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">queryUrl</span><span class="token punctuation">}</span></span><span class="token string">,path:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">path</span><span class="token punctuation">}</span></span><span class="token string">,name:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">name</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnActionExecuted</span><span class="token punctuation">(</span><span class="token class-name">ActionExecutedContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;action 执行后&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>异步过滤器</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>All<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Action_02Filter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IAsyncActionFilter</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Action_01Filter<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Action_02Filter</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Action_01Filter<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnActionExecutionAsync</span><span class="token punctuation">(</span><span class="token class-name">ActionExecutingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">ActionExecutionDelegate</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;action 执行前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//如果标记有允许所有，不做处理那么就跳过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>ActionDescriptor<span class="token punctuation">.</span>EndpointMetadata<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">AllowAnonymousAttribute</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//记录请求来的一些参数</span>
        <span class="token class-name"><span class="token keyword">var</span></span> queryUrl <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Query<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">string</span></span> path <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">string</span></span> name <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identity<span class="token punctuation">?.</span>Name<span class="token punctuation">;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Action信息  queryUrl:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">queryUrl</span><span class="token punctuation">}</span></span><span class="token string">,path:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">path</span><span class="token punctuation">}</span></span><span class="token string">,name:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">name</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;action 执行后&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此方法不同于ActionFilter的是，它能够处理异步操作，同时它是在模型绑定完成之后执行，只有一个异步方法OnActionExecutionAsync。</p><p>另外还可以继承自ActionFilterAttribute，这东西有点类似于Action过滤器和Result的合并使用</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>All<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Action_03Filter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ActionFilterAttribute</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Action_01Filter<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Action_03Filter</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Action_01Filter<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnActionExecuted</span><span class="token punctuation">(</span><span class="token class-name">ActionExecutedContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;action 执行后 OnActionExecuted 1 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnActionExecuted</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnActionExecuting</span><span class="token punctuation">(</span><span class="token class-name">ActionExecutingContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;action 执行前 OnActionExecuting 2 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnActionExecuting</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnActionExecutionAsync</span><span class="token punctuation">(</span><span class="token class-name">ActionExecutingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">ActionExecutionDelegate</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//会进该方法</span>
        <span class="token comment">//OnActionExecuted OnActionExecuting方法我理解是应该在这里根据条件判断去调用上面的方法</span>

        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;action 执行前 OnActionExecutionAsync 3 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;action 执行前 OnActionExecutionAsync 4 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResultExecuted</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutedContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;result 执行后 OnResultExecuted 5 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnResultExecuted</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResultExecuting</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutingContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;result 执行前 OnResultExecuting 6 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnResultExecuting</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnResultExecutionAsync</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">ResultExecutionDelegate</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//会进该方法</span>
        <span class="token comment">//OnResultExecuted、OnResultExecuting方法并不会直接触发，而是根据条件在当前方法中执行调用的</span>

        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;result 执行前 OnResultExecutionAsync 7 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;result 执行后 OnResultExecutionAsync 8 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//返回</span>
        <span class="token comment">//context.Result = new ObjectResult(&quot;&quot;);</span>
        <span class="token comment">//await base.OnResultExecutionAsync(context, next);</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="exception-filter" tabindex="-1"><a class="header-anchor" href="#exception-filter" aria-hidden="true">#</a> Exception Filter</h2><p>异常处理的Filter，可以进行全局的异常日志收集等操作，使用该过滤器需要实现IExceptionFilter接口，实现这个接口需要实现OnException方法，当系统发送未捕捉的异常时候就会触发这个方法，这个方法里面包含了一个ExceptionContext异常上下文，其中包含了具体的异常信息，然后就需要使用日志组件等记录下这个异常。</p><p>注意：只能捕捉Action异常，如果是要做全局异常捕捉还是建议去使用中间件。</p><p>首先自定义一个异常过滤器，然后实现IExceptionFilter接口</p><p>实现方法，先判断异常是否处理过，如果没有处理过那么就进行处理。</p><p>同步方案：</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exception_01Filter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IExceptionFilter</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Exception_01Filter<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IModelMetadataProvider</span> _modelMetadataProvider<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Exception_01Filter</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Exception_01Filter<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">,</span>
        <span class="token class-name">IModelMetadataProvider</span> modelMetadataProvider<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        _modelMetadataProvider <span class="token operator">=</span> modelMetadataProvider<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>ExceptionHandled<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token comment">//日志收集</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Exception<span class="token punctuation">,</span> <span class="token string">&quot;出错&quot;</span> <span class="token operator">+</span> context<span class="token punctuation">?.</span>Exception<span class="token punctuation">?.</span>Message <span class="token operator">??</span> <span class="token string">&quot;异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResultModel<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Message <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;处理失败 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">context<span class="token punctuation">.</span>Exception<span class="token punctuation">.</span>Message</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
            IsSuccess <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            Code <span class="token operator">=</span> <span class="token string">&quot;500&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//或者</span>
        context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonResult</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//如果是mvc使用，那么就可以返回错误界面</span>
        <span class="token comment">//var result = new ViewResult { ViewName = &quot;~/Views/Shared/Error.cshtml&quot; };</span>
        <span class="token comment">//result.ViewData = new Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary(_modelMetadataProvider, context.ModelState);</span>
        <span class="token comment">//context.Result = result;//断路器只要一对result赋值就不继续往后赋值了</span>

        context<span class="token punctuation">.</span>ExceptionHandled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>异步方案</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exception_02Filter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IAsyncExceptionFilter</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Exception_02Filter<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

    <span class="token comment">//构造注入日志组件</span>
    <span class="token keyword">public</span> <span class="token function">Exception_02Filter</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Exception_02Filter<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnExceptionAsync</span><span class="token punctuation">(</span><span class="token class-name">ExceptionContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>ExceptionHandled<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token comment">//日志收集</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Exception<span class="token punctuation">,</span> context<span class="token punctuation">?.</span>Exception<span class="token punctuation">?.</span>Message <span class="token operator">??</span> <span class="token string">&quot;异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResultModel<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Message <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;处理失败 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">context<span class="token punctuation">.</span>Exception<span class="token punctuation">.</span>Message</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
            IsSuccess <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            Code <span class="token operator">=</span> <span class="token string">&quot;500&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> setting <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonSerializerSettings</span>
        <span class="token punctuation">{</span>
            ContractResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Newtonsoft<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>Serialization<span class="token punctuation">.</span>CamelCasePropertyNamesContractResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//指定序列化方式为驼峰式</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>JsonConvert<span class="token punctuation">.</span><span class="token function">SerializeObject</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> setting<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//或者</span>
        <span class="token comment">//context.Result = new JsonResult(response);//断路器只要一对result赋值就不继续往后赋值了</span>
        context<span class="token punctuation">.</span>ExceptionHandled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="result-filter" tabindex="-1"><a class="header-anchor" href="#result-filter" aria-hidden="true">#</a> Result Filter</h2><p>当Action完成后，最终会经过的Filter，可以对结果进行格式化、大小写转换、双语系统等一系列操作。比如根据返回的结果不同，渲染不同的视图(中文视图或者英文视图)等</p><p>同步方案：</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>All<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Result_01Filter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IResultFilter</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IModelMetadataProvider</span> _modelMetadataProvider<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Result_01Filter</span><span class="token punctuation">(</span><span class="token class-name">IModelMetadataProvider</span> modelMetadataProvider<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _modelMetadataProvider <span class="token operator">=</span> modelMetadataProvider<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token doc-comment comment">/// 在result执行前发生(在view 呈现前)，使用场景：设置客户端缓存，服务器端压缩</span>
    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>context<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResultExecuting</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutingContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 在结果执行之前调用的一系列操作  mvc中使用根据不同的参数等返回不同的页面</span>
        <span class="token comment">//var param = context.HttpContext.Request.Query[&quot;View&quot;];</span>
        <span class="token comment">//if (param == &quot;1&quot;)//显示中文系统</span>
        <span class="token comment">//{</span>
        <span class="token comment">//    var result = new ViewResult { ViewName = &quot;~/Views/Test/Chinese.cshtml&quot; };</span>
        <span class="token comment">//    result.ViewData = new Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary(_modelMetadataProvider, context.ModelState);</span>
        <span class="token comment">//    context.Result = result;</span>
        <span class="token comment">//}</span>

        <span class="token comment">//设置响应头</span>
        <span class="token comment">//context.HttpContext.Response.Headers.Add(&quot;&quot;, new string[] { &quot;&quot; });</span>

        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;OnResultExecuting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonResult</span><span class="token punctuation">(</span>ResultModel<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ObjectResult<span class="token punctuation">)</span>context<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token doc-comment comment">/// 渲染视图后执行,当Action完成后</span>
    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>context<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResultExecuted</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutedContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> path <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">;</span>
        <span class="token comment">// 在结果执行之后调用的操作...</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;OnResultExecuted  Path：</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">path</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//注意：目前我并不知道找个方法适合做什么，并且context.Result方法也是只读的。</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>异步方案</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>All<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Result_02Filter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IAsyncResultFilter</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnResultExecutionAsync</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">ResultExecutionDelegate</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonResult</span><span class="token punctuation">(</span>ResultModel<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ObjectResult<span class="token punctuation">)</span>context<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;之前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;之后&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同样的这里我们还可以继承自ResultFilterAttribute。</p><h1 id="注册方式" tabindex="-1"><a class="header-anchor" href="#注册方式" aria-hidden="true">#</a> 注册方式</h1><p>过滤器的注册方式有：Action、Controller、全局</p><h2 id="action注册方式" tabindex="-1"><a class="header-anchor" href="#action注册方式" aria-hidden="true">#</a> Action注册方式</h2><p>局部注册方式，针对控制器中的某个方法上标注特性的方式进行注册，代码如下</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AuthonizationFilter</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="controller注册方式" tabindex="-1"><a class="header-anchor" href="#controller注册方式" aria-hidden="true">#</a> Controller注册方式</h2><p>如果使用action方式，如果一个控制器中的好几个action方式都使用了这个过滤器，那么我们就需要一个一个action进行标注注册，所以我们直接使用控制器注册方式，必须是无参数的构造函数</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AuthonizationFilter</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FirstController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Controller</span></span>
<span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>FirstController<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token function">FirstController</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>FirstController<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		_logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果要传递参数，需要通过TyperFilter标记在方法和控制器</p><p>[TypeFilter(typeof(customerAttribute))]</p><h2 id="全局注册方式" tabindex="-1"><a class="header-anchor" href="#全局注册方式" aria-hidden="true">#</a> 全局注册方式</h2><p>比如说我们需要全局系统中的异常或者收集操作日志等，需要全局注册一个Exception来实现，就不需要一个一个action或者控制器进行注册</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code>services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
	 <span class="token comment">//options.Filters.Add(typeof(CustomerExceptionFilter));</span>
	 options<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Add</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomerExceptionFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	 options<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthorizeFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 options<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">AuthorizeFilter</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="依赖注入两种方式" tabindex="-1"><a class="header-anchor" href="#依赖注入两种方式" aria-hidden="true">#</a> 依赖注入两种方式</h1><h2 id="servicefilterattribute" tabindex="-1"><a class="header-anchor" href="#servicefilterattribute" aria-hidden="true">#</a> ServiceFilterAttribute</h2><p>将要用的ActionFilter本身注册为一个Service注册到DI容器中(必须)。通过ServiceFilter从容器中检索你的ActionFile，并且注入到需要的地方</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//步骤一</span>
services<span class="token punctuation">.</span><span class="token function">AddScoped</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">CustomResourceFilterAttribute</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//步骤二</span>
在action上使用serviceFilter
<span class="token punctuation">[</span><span class="token function">ServiceFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">FilterInjectAttribute</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ServiceFilter</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">FilterInjectAttribute</span><span class="token punctuation">)</span><span class="token punctuation">,</span>IsReusable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ServiceFilter有一个属性叫IsReusable。从字面意思也很好理解，就是是否可重用的意思。显而易见如果这个属性设置为True，那么多个请求就会复用这个ActionFilter,但是并不是真正的单例</p><p>可以支持无参构造函数，可以支持依赖注入，但是必须注册服务</p><h2 id="typefilterattribute" tabindex="-1"><a class="header-anchor" href="#typefilterattribute" aria-hidden="true">#</a> TypeFilterAttribute</h2><p>使用TypeFilterAttribute注入的ActionFilter并不从DI容器中查找，而是直接通过Microsoft.Extensions.DependencyInjection.ObjectFactory来实例化对象。所以我们的FilterInjectAttribute不需要提前注册到DI容器中。</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">TypeFilter</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MyExceptionFilter</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">TypeFilter</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MyExceptionFilter</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> <span class="token string">&quot;aa&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bb&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>Arguments参数是TypeFilterAttribute跟ServiceFilterAttribute的一个重要区别，ServiceFilterAttribute并没有这属性。Arguments类型为object数组。通过TypeFilterAttribute实例化的ActionFilter，如果它的构造器中的参数类型在DI容器中找不到，会继续在Arguments参数列表里按顺序获取。</p><p>可以支持无参构造函数，可以支持依赖注入</p><h1 id="资料" tabindex="-1"><a class="header-anchor" href="#资料" aria-hidden="true">#</a> 资料</h1><p>ASP.NET Core 中的过滤器：https://docs.microsoft.com/zh-cn/aspnet/core/mvc/controllers/filters?view=aspnetcore-6.0</p></div></div><footer class="page-meta"><div class="meta-item edit-link"><a class="icon-container left meta-item-label" href="https://github.com/vuepress-reco/vuepress-theme-reco-next/edit/main/kbms/dotnetcore/filter/base.md" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" style="color:inherit;width:20px;height:20px;font-size:20px;"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 7H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-3"></path><path d="M9 15h3l8.5-8.5a1.5 1.5 0 0 0-3-3L9 12v3"></path><path d="M16 5l3 3"></path></g></svg><span style="color:inherit;font-size:14px;" class="icon-text"><!--[-->Edit this page<!--]--></span></a></div><!----></footer><nav class="page-nav"><p class="hasNext inner"><!----><span class="page-nav-item next">过滤器常见操作 → </span></p></nav><!----></main><!--]--><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#作用范围" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="作用范围"><!--[--><!--]--> 作用范围 <!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#authorization-filter" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="Authorization Filter"><!--[--><!--]--> Authorization Filter <!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#resource-filter" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="Resource Filter"><!--[--><!--]--> Resource Filter <!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#action-filter" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="Action Filter"><!--[--><!--]--> Action Filter <!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#exception-filter" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="Exception Filter"><!--[--><!--]--> Exception Filter <!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#result-filter" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="Result Filter"><!--[--><!--]--> Result Filter <!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#action注册方式" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="Action注册方式"><!--[--><!--]--> Action注册方式 <!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#controller注册方式" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="Controller注册方式"><!--[--><!--]--> Controller注册方式 <!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#全局注册方式" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="全局注册方式"><!--[--><!--]--> 全局注册方式 <!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#servicefilterattribute" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="ServiceFilterAttribute"><!--[--><!--]--> ServiceFilterAttribute <!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/dotnetcore/filter/base.html#typefilterattribute" class="router-link-active router-link-exact-active nav-link page-catalog-item" aria-label="TypeFilterAttribute"><!--[--><!--]--> TypeFilterAttribute <!--[--><!--]--></a></li><!--]--><!--]--></ul></div></div></div></div><!----><!----><!--]--></div>
    <script type="module" src="/assets/app.f6b99883.js" defer></script>
  </body>
</html>
